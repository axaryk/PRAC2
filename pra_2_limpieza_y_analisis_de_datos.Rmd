---
title: 'Tipología y ciclo de vida de los datos'
subtitle: 'PRÁCTICA 2: Limpieza y análisis de datos'
author: "Autores: Eleazar Morales Díaz y Susana Vila Melero"
date: "5/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Descripción del dataset.

¿Qué grupo tiene mayor probabilidad de sobrevivir?
¿Hay relación entre categoría del billete y el pais o puerto de embarque?

Hemos elegido como dataset para realizar nuestra práctica el dataset de "Titanic", ya que nos permite realizar tareas predictivas sobre la variable **Survived**. En esa línea nuestro objetivo será analizar qué subconjunto de personas tendría mayor probabilidad de sobrevivir en el Titanic, a partir de los datos contenidos en el conjunto de datos. Estudiaremos también qué relación hay entre la categoría del billete y el país/puerto de embarque.

El dataset consta de 2.207 registros y 11 variables que se describen a continuación:

* **name**: nombre del pasajero (string).
* **gender**: información respecto al género del pasajero (factor con dos niveles).
* **age**: la edad del pasajero el día del naufragio. La edad de los bebés( menores de 12 meses) se proporciona como una fracción de un año (valor numérico).
* **class**: la clase para los pasajeros o el tipo de servicio para los miembros de la tripulación (factor).
* **embarked**: lugar de embarque del pasajero (factor).
* **country**: lugar de procedencia del pasajero (factor).
* **ticketno**: número de pasaje de los pasajeros, NA en el caso de ser miembros de la tripulación (valor numérico).
* **fare**: Precio del pasaje, NA para miembros de la tripulación, músicos y empleados de la compañía naviera (valor numérico).
* **sibsp**: número de esposas/hermanos a bordo, tomado del dataset Vanderbild (factor ordenado).
* **parch**: número de padres/hijos a bordo, tomado del dataset Vanderbild (factor ordenado).
* **survived**: información respecto a si el pasajero sobrevivió o no al naufragio (factor con dos niveles).


## 2. Integración y selección de los datos de interés a analizar.

El primer paso será cargar las librerias y el dataset con el que vamos a trabajar.Una vez cargado, analizaremos su estructura y el tipo de variable y lo adecuaremos a nuestro estudio.

```{r}
# Cargamos las librerías
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(scales)
library(stats)
theme_set(theme_bw())

# Cargamos el dataset
ds <- read.csv("./data/titanic.csv", header=TRUE, fileEncoding="UTF-8")

#Hacemos una primera inspección
str(ds)
summary(ds)

#Convertimos las variables carácter a variables factor
ds$gender = as.factor(ds$gender)
ds$class = as.factor(ds$class)
ds$embarked = as.factor(ds$embarked)
ds$country = as.factor(ds$country)
ds$sibsp = as.factor(ds$sibsp)
ds$parch = as.factor(ds$parch)
ds$survived = as.factor(ds$survived)
str(ds)
```

Ya tenemos el dataset cargado y con las variables transformadas para poder trabajar con él. 

## 3. Limpieza de datos

### 3.1. Identificación y tratamiento de ceros o elementos vacíos.
### 3.2. Identificación y tratamiento de valores extremos.

## 4. Análisis de los datos.

### 4.1. Selección de los grupos de datos que se quieren comparar/analizar.

A continuación elegiremos qué datos utilizaremos, qué datos eliminaremos y si es necesario crear nuevas variables para llevar a cabo nuestro análisis.

#### 4.1.1. Eliminación de variables.

Descartaremos de nuestro dataset las variables **name** y **ticketno** ya que no aportan información de interés. En el caso de **ticketno**, podría dar información respecto a si el sujeto es pasajero o miembro de la tripulación, pero el mismo dato se puede obtener de la variable **fare** que sí es de interés para nuestro análisis.
```{r}
ds = select(ds, -name, -ticketno)
str(ds)
```

#### 4.1.2. Generación de nuevas variables.

Generaremos una nueva variable que se corresponde a la **edad discretizada**.
```{r}
#Edad discretizada con un método simple de intervalos de igual amplitud.
summary(ds[,"age"])
ds["ageD"] = cut(ds$age, breaks = c(0,10,20,30,40,50,60,70,100), labels = c("0-9", "10-19", "20-29", "30-39","40-49","50-59","60-69","70-79"))
g1 <- ggplot(ds, aes(x = age, fill=survived))+geom_bar(width=0.5)+scale_fill_brewer(palette="Blues")+theme(aspect.ratio = 0.5)+ggtitle("Age Continua")+ylab("Número")
g2 = ggplot(ds, aes(x = ageD, fill=survived)) + geom_bar()+scale_fill_brewer(palette="Blues")+theme(aspect.ratio = 0.5)+ggtitle("Age Discreta")+ylab("Número")
gridExtra::grid.arrange(g1, g2, ncol=1)
```


A continuación crearemos una variable que nos dirá si el sujeto es **miembro de la tripulación o pasajero**.
```{r}
#Nueva variable para identificar pasajeros y miembros de la tripulación
ds$status = ds$fare
ds$status[is.na(ds$status)] = 0
ds$status[ds$status != 0] = 1
ds$status = as.factor(ds$status)
g3 = ggplot(ds, aes(x = status, fill=survived))+ geom_bar()+scale_fill_brewer(palette="Blues")+theme(aspect.ratio = 0.5)+ggtitle("Tripulación/Pasajero")+ylab("Número")
g3
```

Por último, generaremos una variable que nos indicará el tamaño de la familia de cada sujeto.
```{r echo=TRUE, message=FALSE, warning=FALSE}
#Nueva variable para calcular el tamaño de la familia entre los pasajeros
ds$sibspN = as.numeric(ds$sibsp)
ds$parchN = as.numeric(ds$parch)
ds$family = ds$sibspN + ds$parchN +1
ds = select(ds, -sibspN, -parchN)
g4 = ggplot(ds,aes(x=family,fill=survived))+geom_bar()+scale_fill_brewer(palette="Blues")+theme(aspect.ratio = 0.5)+ggtitle("Miembros de la familia")+ylab("Número")
g4
  
```

#### 4.1.3. Selección del grupo de datos para el análisis.

Una vez tenemos el dataset con las variables que necesitamos, seleccionaremos los grupos de datos que puede ser interesante analizar:



* Pasajeros que hayan sobrevivido en función de la edad: **survived** y **age**/**ageD**
* Pasajeros que hayan sobrevivido en función del genero: **survived** y **genre**
* Pasajeros que hayan sobrevivido en función del puerto de embarque: **survived** y **embarked**
* Pasajeros que hayan sobrevivido en función del país de origen: **survived** y **country**
* Pasajeros que hayan sobrevivido en función de la clase: **survived** y **class**
* Pasajeros que hayan sobrevivido en función del tamaño de la familia con la que viajaban: **Survived** y **family**
* Categoría del billete en función del puerto de embarque: **class** y **embarked**
* Categoría del billete en función del país de origen: **class** y **country**
Con los datos anteriores, al llevar a cabo el análisis se verá si resulta de interés hacer alguna combinación de las variables anteriores

### 4.2. Comprobación de la normalidad y homogeneidad de la varianza.

A la hora de realizar un análisis de normalidad y homgeneidad de la varianza, empezaremos con un análisis descriptivo de los datos:
```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(ds)
```

A partir de los datos obtenidos, podemos calcular la normalidad de los tres atributos numéricos: **age**, **fare**, y **family**. Para ello utilizaremos el test de Saphiro-Wilk:
```{r echo=TRUE, message=FALSE, warning=FALSE}
shapiro.test(ds$age)
shapiro.test(ds$fare)
shapiro.test(ds$family)
```

A continuación se analiza el valor de p. En el caso de que sea mayor que el nivel de significancia, se acepta la hipótesis nula y se concluye que la variable tiene una distribución normal.
En nuestro caso XXX

```{r echo=TRUE, message=FALSE, warning=FALSE}
qqnorm(ds$age);qqline(ds$age, col = 2)
qqnorm(ds$fare);qqline(ds$fare, col = 2)
qqnorm(ds$family);qqline(ds$family, col = 2)
```



Seguidamente, pasamos a estudiar la homogeneidad de varianzas mediante la aplicación de un test de Fligner-Killeen. En este caso, estudiaremos la homogeneidad de las cuatro variables anteriormente mencionadas respecto a la variable survived. En nuestro test, la hipótesis nula consiste en que ambas varianzas son iguales. 
```{r echo=TRUE, message=FALSE, warning=FALSE}
fligner.test(age ~ survived, data = ds)
fligner.test(fare ~ survived, data = ds)
fligner.test(family ~ survived, data = ds)
```

Una vez ejecutados los test, podemos aceptar la hipótesis nula en aquellos casos en los que el valor de p sea mayor que el valor de significancia (0,05). 
Por lo tanto, para la variable **age**, con p-valor>0,05 diremos con un 95% de confianza que su varianza es la misma tanto para los supervivientes como para los que no. Siguiendo el mismo razonamiento, para **fare** y **family**, con p-valor<=0,05, afirmaremos que las varianzas de estas variables son diferentes para los dos grupos de la variable "survived".


